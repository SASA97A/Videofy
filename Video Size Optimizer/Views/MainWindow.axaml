<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Video_Size_Optimizer.ViewModels"
        xmlns:model="using:Video_Size_Optimizer.Models"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
		MinWidth="1100" MinHeight="600"
        x:Class="Video_Size_Optimizer.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
		xmlns:Views="using:Video_Size_Optimizer.Views"
		xmlns:conv="using:Video_Size_Optimizer.Converters"
        Icon="/Assets/app.ico"
        Title="Videofy - Video Size Optimizer"
		Background="#1e1e1e">
	
	<Window.Styles>
		<Style Selector="Separator.vertical">
			<Setter Property="Width" Value="1"/>
			<Setter Property="Height" Value="24"/>
			<Setter Property="Margin" Value="5,0"/>
			<Setter Property="Background" Value="#444444"/>
		</Style>
		<Style Selector="DataGridColumnHeader">
			<Setter Property="Background" Value="#2b2b2b"/>
			<Setter Property="Foreground" Value="#00d26a"/>
			<Setter Property="FontWeight" Value="SemiBold"/>
			<Setter Property="FontSize" Value="12"/>
			<Setter Property="Padding" Value="10,5"/>
			<Setter Property="SeparatorBrush" Value="#444444"/>
		</Style>
		<Style Selector="CheckBox:checked /template/ Border#NormalRectangle">
			<Setter Property="Background" Value="#00d26a" />
			<Setter Property="BorderBrush" Value="#00d26a" />
		</Style>

		<Style Selector="CheckBox:pointerover /template/ Border#NormalRectangle">
			<Setter Property="BorderBrush" Value="#00d26a" />
		</Style>

		<Style Selector="CheckBox /template/ Path#CheckGlyph">
			<Setter Property="Fill" Value="White" />
		</Style>
		<!-- Slider thumb hover -->
		<Style Selector="Slider:pointerover /template/ Thumb">
			<Setter Property="Background" Value="#00d26a"/>
		</Style>

		<!-- Slider thumb pressed -->
		<Style Selector="Slider:pressed /template/ Thumb">
			<Setter Property="Background" Value="#00d26a"/>
		</Style>

		<!-- Slider track (left side / decrease button) -->
		<Style Selector="Slider /template/ RepeatButton#PART_DecreaseButton">
			<Setter Property="Background" Value="#00d26a"/>
		</Style>

		<Style Selector="Slider:pointerover /template/ RepeatButton#PART_DecreaseButton">
			<Setter Property="Background" Value="#00d26a"/>
		</Style>

		<!-- Slider track (right side / increase button) -->
		<Style Selector="Slider /template/ RepeatButton#PART_IncreaseButton">
			<Setter Property="Background" Value="#444444"/>
		</Style>

		<Style Selector="Slider:pointerover /template/ RepeatButton#PART_IncreaseButton">
			<Setter Property="Background" Value="#444444"/>
		</Style>

	</Window.Styles>


	<Design.DataContext>
		<!-- This only sets the DataContext for the previewer in an IDE,
             to set the actual DataContext for runtime, set the DataContext property in code (look at App.axaml.cs) -->
		<vm:MainWindowViewModel/>
	</Design.DataContext>

	<Grid RowDefinitions="Auto, *, Auto" Margin="20">

		<StackPanel Grid.Row="0" Margin="-20,-20,-20,20">
			<Menu Background="#2b2b2b">
				<MenuItem Header="_File">
					<MenuItem Header="_Open Folder..."
							  IsEnabled="{Binding !IsBusy}"
							  Command="{Binding BrowseFolderCommand}"
							  CommandParameter="{Binding $parent[Window]}" />
					<Separator />
					<MenuItem Header="_Exit" Click="OnExitClick"/>
				</MenuItem>
				<MenuItem Header="_Selection">
					<MenuItem Header="_Select All" Command="{Binding SelectAllCommand}" IsEnabled="{Binding !IsBusy}" />
					<MenuItem Header="_Deselect All" Command="{Binding DeselectAllCommand}" IsEnabled="{Binding !IsBusy}"/>
				</MenuItem>
				<MenuItem Header="_Help">
					<MenuItem Header="_Global Settings"
							  IsEnabled="{Binding !IsBusy}"
							  Command="{Binding OpenSettingsCommand}"
							  CommandParameter="{Binding $parent[Window]}"/>
					<Separator />
					<MenuItem Header="_Check for Updates" Command="{Binding CheckForUpdatesCommand}" />
					<Separator />
					<MenuItem Header="_About" Command="{Binding ShowAboutCommand}" />
				</MenuItem>
			</Menu>

			<Border Background="#333333" Height="50" BorderBrush="#111111" BorderThickness="0,0,0,1">
				<StackPanel Orientation="Horizontal" Margin="20,0" Spacing="10">
					<Button Command="{Binding BrowseFolderCommand}"
							IsEnabled="{Binding !IsBusy}"
							CommandParameter="{Binding $parent[Window]}"
							Background="Transparent" BorderThickness="0" Padding="10,5" Cursor="Hand">
						<StackPanel Orientation="Horizontal" Spacing="8">
							<Image Width="18" Height="18">
								<Image.Source>
									<SvgImage Source="/Assets/folder.svg"/>
								</Image.Source>
							</Image>
							<TextBlock Text="Open Folder" VerticalAlignment="Center" Foreground="White" />
						</StackPanel>
					</Button>

					<Separator Classes="vertical" />

					<Button Command="{Binding ToggleSelectAllCommand}"
							IsEnabled="{Binding !IsBusy}"
							Background="Transparent" BorderThickness="0" Padding="10,5" Cursor="Hand">
						<StackPanel Orientation="Horizontal" Spacing="8">
							<Image Width="18" Height="18" VerticalAlignment="Center">
								<Image.Source>
									<SvgImage Source="avares://Videofy/Assets/checked.svg"/>
								</Image.Source>
							</Image>

							<TextBlock Text="Toggle All"
									   VerticalAlignment="Center"
									   Foreground="White"
									   />
						</StackPanel>
					</Button>

					<Separator Classes="vertical" />

					<Button Command="{Binding RefreshFolderCommand}"
							IsEnabled="{Binding !IsBusy}"
							Background="Transparent" BorderThickness="0" Padding="10,5" Cursor="Hand">
						<StackPanel Orientation="Horizontal" Spacing="8">
							<Image Width="16" Height="16" VerticalAlignment="Center">
								<Image.Source>
									<SvgImage Source="avares://Videofy/Assets/refresh.svg"/>
								</Image.Source>
							</Image>
							<TextBlock Text="Refresh List" VerticalAlignment="Center" Foreground="White" />
						</StackPanel>
					</Button>

				</StackPanel>
			</Border>
		</StackPanel>

		<Border Grid.Row="1" Background="#2d2d2d" CornerRadius="8" Padding="5">
			<DockPanel>

				<Border DockPanel.Dock="Top"
						Background="#44ff4444"
						IsVisible="{Binding ShowDependencyWarning}"
						Padding="15"
						CornerRadius="5"
						Margin="10">
					<StackPanel>
						<TextBlock Text="FFmpeg Binaries Missing!" FontWeight="Bold" Foreground="White"/>
						<TextBlock TextWrapping="Wrap" FontSize="12" Margin="0,5" Foreground="#EEEEEE">
							To use Videofy, you need the FFmpeg binaries. You can download them automatically or install them manually.
						</TextBlock>

						<TextBox Text="{Binding ExpectedPath}" IsReadOnly="True" FontSize="10" Background="#22000000"/>

						<StackPanel Margin="0,15,0,5">
							<Button Command="{Binding AutoDownloadBinariesCommand}"
									IsVisible="{Binding !IsDownloading}"
									Background="#00d26a" Foreground="Black"
									HorizontalAlignment="Left"
									Padding="15,8" CornerRadius="4" Cursor="Hand">
								<StackPanel Orientation="Horizontal" Spacing="8">
									<TextBlock Text="â¬‡" FontWeight="Bold"/>
									<TextBlock Text="Auto-Download &amp; Install (Beta)" FontWeight="Bold"/>
								</StackPanel>
							</Button>

							<StackPanel Orientation="Horizontal" Spacing="10" IsVisible="{Binding IsDownloading}">
								<ProgressBar IsIndeterminate="True" Width="100" Height="4" VerticalAlignment="Center" Foreground="#00d26a"/>
								<TextBlock Text="Downloading and Extracting... Please wait." VerticalAlignment="Center" Foreground="#00d26a" FontStyle="Italic"/>
							</StackPanel>
						</StackPanel>

						<Separator Background="#FFFFFF" Opacity="0.2" Margin="0,10"/>

						<TextBlock Text="Manual Options:" FontSize="10" Opacity="0.7" Margin="0,0,0,5"/>

						<StackPanel Orientation="Horizontal" Spacing="10" IsEnabled="{Binding !IsDownloading}">
							<Button Content="1. Open Download Page"
									Command="{Binding OpenBtbNCommand}"
									Background="#3d3d3d" Foreground="White"
									Padding="10,5" CornerRadius="4" FontSize="11" Cursor="Hand"/>

							<Button Content="2. Open Dest Folder"
									Command="{Binding OpenExpectedFolderCommand}"
									Background="#3d3d3d" Foreground="White"
									Padding="10,5" CornerRadius="4" FontSize="11" Cursor="Hand"/>

							<Button Content="3. Check Again"
									Command="{Binding RefreshDependencyCheckCommand}"
									Background="#3d3d3d" Foreground="White"
									Padding="10,5" CornerRadius="4" FontSize="11" Cursor="Hand"/>
						</StackPanel>
					</StackPanel>
				</Border>

				<Panel>
					<DockPanel IsVisible="{Binding HasVideos}">
						<TextBox DockPanel.Dock="Top"
								 Text="{Binding SearchText}"
								 IsEnabled="{Binding !IsBusy}"
								 Watermark="ðŸ” Search by file or folder name..."
								 Margin="5"
								 Background="#333333"
								 Foreground="White"
								 BorderBrush="#444444"
								 VerticalContentAlignment="Center"/>

						<DataGrid ItemsSource="{Binding DisplayedVideos}"
								  IsReadOnly="{Binding IsBusy}"
								  AutoGenerateColumns="False"
								  CanUserSortColumns="True"
								  CanUserResizeColumns="True"
								  ColumnHeaderHeight="40"
								  GridLinesVisibility="None"
								  Background="Transparent"
								  BorderThickness="0">
							<DataGrid.Columns>
								<DataGridTemplateColumn Width="120" CanUserResize="False">
									<DataGridTemplateColumn.Header>
										<TextBlock Text="Selected" HorizontalAlignment="Center" />
									</DataGridTemplateColumn.Header>
									<DataGridTemplateColumn.CellTemplate>
										<DataTemplate>
											<CheckBox IsChecked="{Binding IsSelected}"
													  IsEnabled="{Binding !$parent[DataGrid].DataContext.IsBusy}"
													  HorizontalAlignment="Center"
													  VerticalAlignment="Center"
													  Cursor="Hand"/>
										</DataTemplate>
									</DataGridTemplateColumn.CellTemplate>
								</DataGridTemplateColumn>

								<DataGridTemplateColumn Header="File Name" Width="0.8*">
									<DataGridTemplateColumn.CellTemplate>
										<DataTemplate>
											<StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="10,0">
												<TextBlock Text="{Binding FileName}" 
														   VerticalAlignment="Center" 
														   Foreground="White"
														   TextTrimming="CharacterEllipsis"
														   ToolTip.Tip="{Binding FileName}"/>

												<Border Background="#1a3d2b"
														BorderBrush="#d1b608"
														BorderThickness="1"
														CornerRadius="10"
														Padding="6,1"
														Margin="10,0,0,0"
														IsVisible="{Binding HasCustomSize}"
														ToolTip.Tip="This file will be compressed to a specific target size.">
													<StackPanel Orientation="Horizontal" VerticalAlignment="Center">
														<TextBlock Text="Target size " FontSize="11" VerticalAlignment="Center"/>
														<TextBlock Text="{Binding CustomSizeDisplay}"
																   Foreground="#00d26a"
																   FontSize="11"
																   FontWeight="Bold"
																   VerticalAlignment="Center"/>
													</StackPanel>
												</Border>
											</StackPanel>
										</DataTemplate>
									</DataGridTemplateColumn.CellTemplate>
								</DataGridTemplateColumn>

								<DataGridTemplateColumn Header="Folder" Width="0.6*">
									<DataGridTemplateColumn.CellTemplate>
										<DataTemplate>
											<TextBlock Text="{Binding FolderName}"
													   VerticalAlignment="Center"
													   Margin="10,0"
													   Foreground="White"
													   TextTrimming="CharacterEllipsis"
													   ToolTip.Tip="{Binding FolderName}"/>
										</DataTemplate>
									</DataGridTemplateColumn.CellTemplate>
								</DataGridTemplateColumn>

								<DataGridTemplateColumn Header="Size" Width="Auto" SortMemberPath="RawSizeBytes" CanUserResize="False">
									<DataGridTemplateColumn.CellTemplate>
										<DataTemplate x:DataType="model:VideoFile">
											<TextBlock Text="{Binding FileSizeDisplay}" VerticalAlignment="Center" Margin="10,0" Foreground="White" FontSize="12"/>
										</DataTemplate>
									</DataGridTemplateColumn.CellTemplate>
								</DataGridTemplateColumn>

								<DataGridTemplateColumn Header="Status" Width="150" CanUserResize="False">
									<DataGridTemplateColumn.CellTemplate>
										<DataTemplate>
											<Grid Margin="10,0">

												<StackPanel VerticalAlignment="Center" Margin="10,0">
													<Grid>
												<ProgressBar Height="6"
															 Value="{Binding Progress}"
															 IsIndeterminate="{Binding ShowIndeterminate}"
															 Opacity="{Binding IsProcessing}"
															 IsHitTestVisible="False"
															 Foreground="#00d26a"
															 Background="#444444"
															 CornerRadius="3"
															 VerticalAlignment="Center"/>
													</Grid>
													<TextBlock Text="{Binding Eta}"
															   IsVisible="{Binding IsProcessing}"
															   FontSize="10"
															   Foreground="#CCCCCC"
															   HorizontalAlignment="Right"
															   Margin="0,2,0,0"/>
												</StackPanel>
												
												<TextBlock Text="Completed"
														   Foreground="LimeGreen"
														   FontWeight="Medium"
														   Opacity="{Binding IsCompleted}"
														   IsHitTestVisible="False"
														   VerticalAlignment="Center"/>

												<TextBlock Text="Ready"
														   Foreground="#F5F5F5"
														   Opacity="{Binding IsReady}"
														   VerticalAlignment="Center"/>

												<TextBlock Text="Optimized"
															Foreground="#d1b608"
															FontStyle="Italic"
															FontSize="11"
															Opacity="{Binding IsInvalid}"
															IsHitTestVisible="False"
															VerticalAlignment="Center"/>
											</Grid>
										</DataTemplate>
									</DataGridTemplateColumn.CellTemplate>
								</DataGridTemplateColumn>


								<DataGridTemplateColumn Header="Override" Width="110">
									<DataTemplate>
										<Button
												Background="Transparent"
												FontSize="14"
												HorizontalAlignment="Center"
												Tag="{Binding HasCustomSize}"
												Cursor="Hand"
												IsEnabled="{Binding !$parent[DataGrid].DataContext.IsBusy}">
											<Button.Styles>
												<Style Selector="Image">
													<Setter Property="Opacity" Value="0.4"/>
												</Style>
												<Style Selector="Button[Tag=True] Image">
													<Setter Property="Opacity" Value="1.0"/>
												</Style>
												<Style Selector="Button:disabled Image">
													<Setter Property="Opacity" Value="0.1"/>
												</Style>
											</Button.Styles>

											<Image Width="16" Height="16">
												<Image.Source>
													<SvgImage Source="avares://Videofy/Assets/target.svg"/>
												</Image.Source>
											</Image>

											<Button.Flyout>
												<Flyout Placement="BottomEdgeAlignedLeft">
													<Border Padding="15" Background="#2b2b2b" CornerRadius="8" BorderBrush="#444444" BorderThickness="1">
														<StackPanel Spacing="10" Width="240">
															<StackPanel Spacing="2">
																<TextBlock Text="Target Size Override" FontWeight="Bold" Foreground="#00d26a" FontSize="12"/>
																<TextBlock Text="Note: This file will ignore global CRF and target this specific size."
																		   Foreground="#CCCCCC" FontSize="10" TextWrapping="Wrap" FontStyle="Italic"/>
															</StackPanel>

															<Grid ColumnDefinitions="*, Auto" VerticalAlignment="Center">
																<Slider
																		Minimum="5"
																		Maximum="{Binding MaxTargetMb}"
																		Value="{Binding CustomTargetSizeMbSlider, Mode=TwoWay}"
																		TickFrequency="5"
																		IsSnapToTickEnabled="True"
																		VerticalAlignment="Center"/>

																<Border Grid.Column="1"
																		Background="#3d3d3d"
																		CornerRadius="4"
																		Width="55" Height="22"
																		Margin="10,0,0,0"
																		VerticalAlignment="Center">
																	<StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
																		<TextBlock Text="{Binding CustomTargetSizeMbSlider}"
																				   Foreground="White" FontSize="11" FontWeight="Bold"/>
																		<TextBlock Text="MB" Foreground="#888888" FontSize="8" Margin="2,0,0,0" VerticalAlignment="Bottom"/>
																	</StackPanel>
																</Border>
															</Grid>

															<Button Content="Clear Override"
																	HorizontalAlignment="Stretch"
																	HorizontalContentAlignment="Center"
																	Command="{Binding $parent[DataGrid].DataContext.ClearCustomSizeCommand}"
																	CommandParameter="{Binding}"
																	FontSize="11" Background="#443333" Height="30" VerticalContentAlignment="Center"/>
														</StackPanel>
													</Border>
												</Flyout>
											</Button.Flyout>
										</Button>
									</DataTemplate>
								</DataGridTemplateColumn>
								
								
								<DataGridTemplateColumn Width="50" CanUserResize="False">
									<DataGridTemplateColumn.CellTemplate>
										<DataTemplate>
											<Button Command="{Binding $parent[DataGrid].DataContext.RemoveVideoCommand}"
													CommandParameter="{Binding}"
													Content="âœ•"
													Background="Transparent"
													BorderThickness="0"
													Foreground="#666666"
													FontSize="12"
													VerticalAlignment="Center"
													HorizontalAlignment="Center"
													Cursor="Hand"
													IsEnabled="{Binding !$parent[DataGrid].DataContext.IsBusy}">
													<Button.Styles>
													<Style Selector="Button:hover /template/ ContentPresenter">
														<Setter Property="Background" Value="Transparent"/>
														<Setter Property="TextBlock.Foreground" Value="#ff4444"/>
													</Style>
												</Button.Styles>
											</Button>
										</DataTemplate>
									</DataGridTemplateColumn.CellTemplate>
								</DataGridTemplateColumn>
							</DataGrid.Columns>
						</DataGrid>
					</DockPanel>

					<StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="15" IsVisible="{Binding !HasVideos}">
						<Image Width="64" Height="64" HorizontalAlignment="Center" Opacity="0.3">
							<Image.Source>
								<SvgImage Source="avares://Videofy/Assets/folder.svg"/>
							</Image.Source>
						</Image>
						<TextBlock Text="No videos loaded yet" FontSize="18" FontWeight="SemiBold" Foreground="Gray" HorizontalAlignment="Center"/>
						<Button Command="{Binding BrowseFolderCommand}"
								CommandParameter="{Binding $parent[Window]}"
								Background="#3d3d3d" CornerRadius="20" Cursor="Hand" HorizontalAlignment="Center">
							<TextBlock Text="+ Add Files" Foreground="#00d26a" Margin="10,5"/>
						</Button>
					</StackPanel>
				</Panel>
			</DockPanel>
		</Border>

		<Border Grid.Row="2" Margin="-20,20,-20,-20" BorderBrush="#111111" BorderThickness="0,1,0,0" Height="230">
			<TabControl SelectedIndex="{Binding SelectedTabIndex, Mode=TwoWay}" Padding="0" Margin="0">
				<TabControl.Styles>
					<Style Selector="TabItem">
						<Setter Property="FontSize" Value="12"/>
						<Setter Property="FontWeight" Value="SemiBold"/>
						<Setter Property="MinHeight" Value="30"/>
						<Setter Property="Background" Value="#2b2b2b"/>
						<Setter Property="Foreground" Value="#888888"/>
					</Style>
					<Style Selector="TabItem:selected">
						<Setter Property="Foreground" Value="#00d26a"/>
						<Setter Property="Background" Value="#333333"/>
					</Style>
					<Style Selector="TabControl /template/ ContentPresenter#PART_SelectedContentHost">
						<Setter Property="Padding" Value="0"/>
					</Style>
				</TabControl.Styles>

				<TabItem Header="OPTIMIZE (COMPRESS)" IsEnabled="{Binding !IsBusy}">
					<Views:CompressionView/>
				</TabItem>

				<TabItem Header="CONVERT (INSTANT)" IsEnabled="{Binding !IsBusy}">
					<Views:ConversionView/>
				</TabItem>
			</TabControl>
		</Border>	
		
	</Grid>
</Window>